/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={32588:function(e,n,t){"use strict";e.exports=t.p+"8282097d8a46980c2b50.css"},57847:function(e,n,t){"use strict";e.exports=t.p+"fe6dc9838bf3040b3914.js"},58394:function(e,n,t){"use strict";e.exports=t.p+"9e8e59747971b58b1924.css"},60947:function(e,n,t){"use strict";e.exports=t.p+"85011ed025ede5abc9bb.js"},61414:function(e,n,t){"use strict";e.exports=t.p+"442513e5c942e500078c.css"},98893:function(e,n,t){"use strict";e.exports=t.p+"1b457b94e25b9efe6b05.js"}},n={};function t(r){var o=n[r];if(void 0!==o)return o.exports;var a=n[r]={exports:{}};return e[r](a,a.exports,t),a.exports}t.m=e,t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},function(){var e;t.g.importScripts&&(e=t.g.location+"");var n=t.g.document;if(!e&&n&&(n.currentScript&&"SCRIPT"===n.currentScript.tagName.toUpperCase()&&(e=n.currentScript.src),!e)){var r=n.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e}(),t.b=document.baseURI||self.location.href,function(){function e(){var t,r,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",c=o.toStringTag||"@@toStringTag";function s(e,o,a,c){var s=o&&o.prototype instanceof i?o:i,l=Object.create(s.prototype);return n(l,"_invoke",function(e,n,o){var a,c,s,i=0,l=o||[],d=!1,f={p:0,n:0,v:t,a:p,f:p.bind(t,4),d:function(e,n){return a=e,c=0,s=t,f.n=n,u}};function p(e,n){for(c=e,s=n,r=0;!d&&i&&!o&&r<l.length;r++){var o,a=l[r],p=f.p,w=a[2];e>3?(o=w===n)&&(s=a[(c=a[4])?5:(c=3,3)],a[4]=a[5]=t):a[0]<=p&&((o=e<2&&p<a[1])?(c=0,f.v=n,f.n=a[1]):p<w&&(o=e<3||a[0]>n||n>w)&&(a[4]=e,a[5]=n,f.n=w,c=0))}if(o||e>1)return u;throw d=!0,n}return function(o,l,w){if(i>1)throw TypeError("Generator is already running");for(d&&1===l&&p(l,w),c=l,s=w;(r=c<2?t:s)||!d;){a||(c?c<3?(c>1&&(f.n=-1),p(c,s)):f.n=s:f.v=s);try{if(i=2,a){if(c||(o="next"),r=a[o]){if(!(r=r.call(a,s)))throw TypeError("iterator result is not an object");if(!r.done)return r;s=r.value,c<2&&(c=0)}else 1===c&&(r=a.return)&&r.call(a),c<2&&(s=TypeError("The iterator does not provide a '"+o+"' method"),c=1);a=t}else if((r=(d=f.n<0)?s:e.call(n,f))!==u)break}catch(e){a=t,c=1,s=e}finally{i=1}}return{value:r,done:d}}}(e,a,c),!0),l}var u={};function i(){}function l(){}function d(){}r=Object.getPrototypeOf;var f=[][a]?r(r([][a]())):(n(r={},a,function(){return this}),r),p=d.prototype=i.prototype=Object.create(f);function w(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,n(e,c,"GeneratorFunction")),e.prototype=Object.create(p),e}return l.prototype=d,n(p,"constructor",d),n(d,"constructor",l),l.displayName="GeneratorFunction",n(d,c,"GeneratorFunction"),n(p),n(p,c,"Generator"),n(p,a,function(){return this}),n(p,"toString",function(){return"[object Generator]"}),(e=function(){return{w:s,m:w}})()}function n(e,t,r,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}n=function(e,t,r,o){function c(t,r){n(e,t,function(e){return this._invoke(t,r,e)})}t?a?a(e,t,{value:r,enumerable:!o,configurable:!o,writable:!o}):e[t]=r:(c("next",0),c("throw",1),c("return",2))},n(e,t,r,o)}function t(e,n,t,r,o,a,c){try{var s=e[a](c),u=s.value}catch(e){return void t(e)}s.done?n(u):Promise.resolve(u).then(r,o)}function r(e){return function(){var n=this,r=arguments;return new Promise(function(o,a){var c=e.apply(n,r);function s(e){t(c,o,a,s,u,"next",e)}function u(e){t(c,o,a,s,u,"throw",e)}s(void 0)})}}var o="https://localhost:4000",a=null,c=1;"undefined"==typeof window||window.uploadContext||(window.uploadContext="default");var s={step1:null,step2:null,step3:null,step4:null,step5:null,step6:null},u=null;function i(){return l.apply(this,arguments)}function l(){return(l=r(e().m(function n(){var t;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,console.log("🚀 初始化主控制器..."),p(),e.n=1,d();case 1:return e.n=2,I();case 2:return e.n=3,U();case 3:console.log("✅ 主控制器初始化完成"),e.n=5;break;case 4:e.p=4,t=e.v,console.error("❌ 主控制器初始化失败:",t),T("Application initialization failed","error"),w(1);case 5:return e.a(2)}},n,null,[[0,4]])}))).apply(this,arguments)}function d(){return f.apply(this,arguments)}function f(){return(f=r(e().m(function n(){var t;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,void 0!==window.MainPageModule){e.n=1;break}console.warn("⚠️ MainPage 模块未加载"),e.n=2;break;case 1:return e.n=2,window.MainPageModule.init({API_BASE_URL:o,showStep:w,showStatusMessage:T,delayedNavigation:y,saveDocumentIdToSettings:P,setCurrentDocumentId:function(e){window.currentDocumentId=e},setUploadedProtocol:function(e){a=e}});case 2:if(void 0!==window.CostEstimateModule){e.n=3;break}console.warn("⚠️ CostEstimate 模块未加载"),e.n=4;break;case 3:return e.n=4,window.CostEstimateModule.init({API_BASE_URL:o,showStep:w,showStatusMessage:T,cacheExcelState:C,restoreExcelState:S,clearDocumentIdFromSettings:N,setUploadedProtocol:function(e){a=e},getCurrentDocumentId:function(){return window.currentDocumentId},setCurrentDocumentId:function(e){window.currentDocumentId=e}});case 4:console.log("✅ 所有模块初始化完成"),e.n=6;break;case 5:throw e.p=5,t=e.v,console.error("❌ 模块初始化失败:",t),t;case 6:return e.a(2)}},n,null,[[0,5]])}))).apply(this,arguments)}function p(){c=1;var n=document.getElementById("wizard-back-btn"),t=document.getElementById("wizard-next-btn");n&&n.addEventListener("click",r(e().m(function n(){var t;return e().w(function(e){for(;;)switch(e.n){case 0:if(!(c>1)){e.n=2;break}return t=c-1,e.n=1,S(t);case 1:w(t);case 2:return e.a(2)}},n)}))),t&&t.addEventListener("click",r(e().m(function n(){return e().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,m();case 1:return e.a(2)}},n)}))),C(1)}function w(e){c=e,document.querySelectorAll(".wizard-page").forEach(function(n){var t=Number(n.getAttribute("data-step"));n.style.display=t===e?"block":"none"});var n,t=document.getElementById("wizard-back-btn"),r=document.getElementById("wizard-next-btn"),o=document.querySelector(".wizard-nav");if(1===e)o&&(o.style.display="none");else if(2===e&&"undefined"!=typeof window&&"from_chat"===window.uploadContext)o&&(o.style.display="none");else if(o&&(o.style.display="flex"),t&&(t.disabled=!1),r){r.disabled=!1;var a=r.querySelector(".ms-Button-label");a&&(a.textContent=6===e?"Done":"Next")}(n=e)<=2&&window.MainPageModule&&window.MainPageModule.onStepEnter?window.MainPageModule.onStepEnter(n):n>=3&&n<=6&&window.CostEstimateModule&&window.CostEstimateModule.onStepEnter&&window.CostEstimateModule.onStepEnter(n)}function m(){return h.apply(this,arguments)}function h(){return(h=r(e().m(function n(){return e().w(function(e){for(;;)switch(e.n){case 0:if(1!==c){e.n=1;break}return console.warn("Step 1 Next应该由AI Assistant模块处理"),e.a(2);case 1:if(2!==c){e.n=5;break}if(!window.MainPageModule||!window.MainPageModule.handleNext){e.n=3;break}return e.n=2,window.MainPageModule.handleNext(c);case 2:e.n=4;break;case 3:return e.n=4,b(c);case 4:case 8:case 9:return e.a(2);case 5:if(!(c>=3&&c<=6)){e.n=9;break}if(!window.CostEstimateModule||!window.CostEstimateModule.handleNext){e.n=7;break}return e.n=6,window.CostEstimateModule.handleNext(c);case 6:e.n=8;break;case 7:return e.n=8,b(c)}},n)}))).apply(this,arguments)}function b(e){return v.apply(this,arguments)}function v(){return(v=r(e().m(function n(t){var r,a,c,s;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:console.warn("模块未实现handleNext，使用降级处理: Step ".concat(t)),c=t,e.n=2===c?1:3===c?4:4===c||5===c?13:6===c?15:27;break;case 1:return e.n=2,C(2);case 2:if(window.currentDocumentId){e.n=3;break}return T("Please upload a protocol document before proceeding.","error"),e.a(2);case 3:return w(3),e.a(3,27);case 4:if(!window.CostEstimateModule||!window.CostEstimateModule.saveProjectSelectionDetails){e.n=12;break}return e.p=5,e.n=6,window.CostEstimateModule.saveProjectSelectionDetails();case 6:if(console.log("✅ 项目选择已保存，状态: project_selection_done"),!window.CostEstimateModule.createStandardCostAnalysisHeaders){e.n=7;break}return e.n=7,window.CostEstimateModule.createStandardCostAnalysisHeaders();case 7:if(!window.CostEstimateModule.populateExcelWithSelectedProjects){e.n=8;break}return e.n=8,window.CostEstimateModule.populateExcelWithSelectedProjects();case 8:return e.n=9,C(t);case 9:return w(t+1),e.n=10,E();case 10:e.n=12;break;case 11:return e.p=11,s=e.v,console.error("❌ 保存项目选择失败:",s),T("Failed to save project selection","error"),e.a(2);case 12:return e.a(3,27);case 13:return e.n=14,C(t);case 14:return w(t+1),e.a(3,27);case 15:return e.n=16,C(6);case 16:if(window.currentDocumentId){e.n=17;break}return T("Missing document id. Please upload again.","error"),e.a(2);case 17:return e.p=17,e.n=18,fetch("".concat(o,"/api/documents/").concat(window.currentDocumentId,"/mark-complete"),{method:"PATCH"});case 18:return r=e.v,e.n=19,r.json();case 19:if(null==(a=e.v)||!a.success){e.n=23;break}if(T("Project completed! Saving Excel file and starting fresh...","success"),!window.CostEstimateModule||!window.CostEstimateModule.saveExcelToLocal){e.n=20;break}return e.n=20,window.CostEstimateModule.saveExcelToLocal();case 20:if(!window.CostEstimateModule||!window.CostEstimateModule.clearExcelContent){e.n=21;break}return e.n=21,window.CostEstimateModule.clearExcelContent();case 21:if(!window.CostEstimateModule||!window.CostEstimateModule.resetToStart){e.n=22;break}return e.n=22,window.CostEstimateModule.resetToStart();case 22:e.n=24;break;case 23:T("Failed to mark as completed: "+((null==a?void 0:a.message)||""),"error");case 24:e.n=26;break;case 25:e.p=25,T("Failed to mark as completed: "+e.v.message,"error");case 26:return e.a(3,27);case 27:return e.a(2)}},n,null,[[17,25],[5,11]])}))).apply(this,arguments)}function y(e){return g.apply(this,arguments)}function g(){return g=r(e().m(function n(t){var r,o=arguments;return e().w(function(e){for(;;)switch(e.n){case 0:return r=o.length>1&&void 0!==o[1]?o[1]:2e3,e.n=1,new Promise(function(e){return setTimeout(e,r)});case 1:w(t);case 2:return e.a(2)}},n)})),g.apply(this,arguments)}function E(){return k.apply(this,arguments)}function k(){return(k=r(e().m(function n(){var t,a,c;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:if(n.p=0,console.log("🔄 开始自动触发SDTM分析..."),t=window.currentDocumentId){n.n=1;break}throw new Error("No document ID available");case 1:return n.n=2,fetch("".concat(o,"/api/documents/").concat(t,"/analyze-sdtm"),{method:"POST",headers:{"Content-Type":"application/json"}});case 2:if((a=n.v).ok){n.n=3;break}throw new Error("SDTM analysis failed: ".concat(a.statusText));case 3:return n.n=4,a.json();case 4:n.v,console.log("✅ SDTM分析完成，状态: sdtm_ai_analysis_done"),setTimeout(r(e().m(function n(){return e().w(function(e){for(;;)switch(e.n){case 0:if(w(5),!window.CostEstimateModule||!window.CostEstimateModule.loadAndDisplaySDTMResults){e.n=1;break}return e.n=1,window.CostEstimateModule.loadAndDisplaySDTMResults();case 1:return e.a(2)}},n)})),2e3),n.n=6;break;case 5:n.p=5,c=n.v,console.error("❌ SDTM分析失败:",c),T("SDTM Analysis failed: "+c.message,"error");case 6:return n.a(2)}},n,null,[[0,5]])}))).apply(this,arguments)}function C(e){return M.apply(this,arguments)}function M(){return M=r(e().m(function n(t){var o;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,Excel.run(function(){var n=r(e().m(function n(r){var o,a;return e().w(function(e){for(;;)switch(e.n){case 0:if(o=r.workbook.worksheets.getActiveWorksheet(),!(a=o.getUsedRange())){e.n=2;break}return a.load(["values","formulas"]),e.n=1,r.sync();case 1:s["step".concat(t)]={values:a.values,formulas:a.formulas,rowCount:a.rowCount,columnCount:a.columnCount},e.n=3;break;case 2:s["step".concat(t)]=null;case 3:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:console.log("✅ 缓存Step ".concat(t," Excel状态成功")),n.n=3;break;case 2:n.p=2,o=n.v,console.warn("⚠️ 缓存Step ".concat(t," Excel状态失败:"),o);case 3:return n.a(2)}},n,null,[[0,2]])})),M.apply(this,arguments)}function S(e){return x.apply(this,arguments)}function x(){return x=r(e().m(function n(t){var o,a;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,o=s["step".concat(t)],n.n=1,Excel.run(function(){var n=r(e().m(function n(t){var r,a,c,s,u;return e().w(function(e){for(;;)switch(e.n){case 0:if(r=t.workbook.worksheets.getActiveWorksheet(),!(a=r.getUsedRange())){e.n=1;break}return a.clear(),e.n=1,t.sync();case 1:if(!o||!o.values){e.n=2;break}return c=o.rowCount,s=o.columnCount,(u=r.getRange(0,0,c,s)).values=o.values,o.formulas&&(u.formulas=o.formulas),e.n=2,t.sync();case 2:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:console.log("✅ 恢复Step ".concat(t," Excel状态成功")),n.n=3;break;case 2:n.p=2,a=n.v,console.warn("⚠️ 恢复Step ".concat(t," Excel状态失败:"),a);case 3:return n.a(2)}},n,null,[[0,2]])})),x.apply(this,arguments)}function I(){return D.apply(this,arguments)}function D(){return D=r(e().m(function n(){var t;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,Excel.run(function(){var n=r(e().m(function n(t){return e().w(function(n){for(;;)switch(n.n){case 0:t.workbook.worksheets.getActiveWorksheet().onChanged.add(function(){var n=r(e().m(function n(t){var o;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,Excel.run(function(){var n=r(e().m(function n(o){var a,c,s,i;return e().w(function(n){for(;;)switch(n.n){case 0:return a=o.workbook.worksheets.getItem(t.worksheetId),(c=a.getRange(t.address)).load(["columnIndex","columnCount"]),n.n=1,o.sync();case 1:if(s=c.columnIndex,i=s+c.columnCount-1,s<=1&&i>=1){n.n=2;break}return n.a(2);case 2:u&&clearTimeout(u),u=setTimeout(r(e().m(function n(){return e().w(function(e){for(;;)switch(e.n){case 0:if(!window.CostEstimateModule||!window.CostEstimateModule.saveExcelChangesToDatabase){e.n=1;break}return e.n=1,window.CostEstimateModule.saveExcelChangesToDatabase();case 1:return e.a(2)}},n)})),1e3);case 3:return n.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:n.n=3;break;case 2:n.p=2,o=n.v,console.warn("Excel变化处理失败:",o);case 3:return n.a(2)}},n,null,[[0,2]])}));return function(e){return n.apply(this,arguments)}}());case 1:return n.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:console.log("✅ Excel变化监听初始化成功"),n.n=3;break;case 2:n.p=2,t=n.v,console.error("❌ Excel变化监听初始化失败:",t);case 3:return n.a(2)}},n,null,[[0,2]])})),D.apply(this,arguments)}function T(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";console.log("[".concat(n.toUpperCase(),"] ").concat(e));var t=document.getElementById("status-message");t||((t=document.createElement("div")).id="status-message",t.className="status-message",document.body.appendChild(t)),t.textContent=e,t.className="status-message ".concat(n),t.style.display="block",setTimeout(function(){t.style.display="none"},3e3)}function P(e){return j.apply(this,arguments)}function j(){return j=r(e().m(function n(t){var o;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,Excel.run(function(){var n=r(e().m(function n(r){return e().w(function(e){for(;;)switch(e.n){case 0:return r.workbook.settings.add("currentDocumentId",t),e.n=1,r.sync();case 1:window.currentDocumentId=t,console.log("✅ 文档ID已保存: ".concat(t));case 2:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:n.n=3;break;case 2:n.p=2,o=n.v,console.error("❌ 保存文档ID失败:",o);case 3:return n.a(2)}},n,null,[[0,2]])})),j.apply(this,arguments)}function A(){return O.apply(this,arguments)}function O(){return O=r(e().m(function n(){var t;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,Excel.run(function(){var n=r(e().m(function n(t){var r,o,a;return e().w(function(e){for(;;)switch(e.n){case 0:return r=t.workbook.settings,(o=r.getItemOrNullObject("currentDocumentId")).load("value"),e.n=1,t.sync();case 1:if(!o.isNullObject){e.n=2;break}return e.a(2,null);case 2:return a=o.value,window.currentDocumentId=a,console.log("✅ 文档ID已加载: ".concat(a)),e.a(2,a)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:return n.a(2,n.v);case 2:return n.p=2,t=n.v,console.error("❌ 加载文档ID失败:",t),n.a(2,null)}},n,null,[[0,2]])})),O.apply(this,arguments)}function N(){return R.apply(this,arguments)}function R(){return R=r(e().m(function n(){var t;return e().w(function(n){for(;;)switch(n.p=n.n){case 0:return n.p=0,n.n=1,Excel.run(function(){var n=r(e().m(function n(t){var r,o;return e().w(function(e){for(;;)switch(e.n){case 0:return r=t.workbook.settings,o=r.getItemOrNullObject("currentDocumentId"),e.n=1,t.sync();case 1:if(o.isNullObject){e.n=2;break}return o.delete(),e.n=2,t.sync();case 2:window.currentDocumentId=null,console.log("✅ 文档ID已清除");case 3:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}());case 1:n.n=3;break;case 2:n.p=2,t=n.v,console.error("❌ 清除文档ID失败:",t);case 3:return n.a(2)}},n,null,[[0,2]])})),R.apply(this,arguments)}function U(){return _.apply(this,arguments)}function _(){return(_=r(e().m(function n(){var t,r;return e().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,A();case 1:if(!(t=e.v)){e.n=3;break}if(console.log("🔄 发现已保存的文档ID，尝试恢复状态..."),!window.CostEstimateModule||!window.CostEstimateModule.restoreApplicationState){e.n=2;break}return e.n=2,window.CostEstimateModule.restoreApplicationState(t);case 2:w(5),e.n=4;break;case 3:w(1);case 4:e.n=6;break;case 5:e.p=5,r=e.v,console.error("❌ 状态恢复失败:",r),w(1);case 6:return e.a(2)}},n,null,[[0,5]])}))).apply(this,arguments)}Office.onReady(function(){var n=r(e().m(function n(t){return e().w(function(e){for(;;)switch(e.n){case 0:if(t.host!==Office.HostType.Excel){e.n=1;break}return document.getElementById("sideload-msg").style.display="none",document.getElementById("app-body").style.display="flex",e.n=1,i();case 1:return e.a(2)}},n)}));return function(e){return n.apply(this,arguments)}}()),window.triggerSDTMAnalysis=E,window.TaskPaneController={showStep:w,showStatusMessage:T,delayedNavigation:y,cacheExcelState:C,restoreExcelState:S,getCurrentStep:function(){return c},getUploadedProtocol:function(){return a},setUploadedProtocol:function(e){a=e},saveDocumentIdToSettings:P,loadDocumentIdFromSettings:A,clearDocumentIdFromSettings:N,API_BASE_URL:o}}(),function(){"use strict";new URL(t(58394),t.b),new URL(t(32588),t.b),new URL(t(61414),t.b),new URL(t(57847),t.b),new URL(t(98893),t.b),new URL(t(60947),t.b)}()}();
//# sourceMappingURL=taskpane.js.map