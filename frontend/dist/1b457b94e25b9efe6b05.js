/*! For license information please see 1b457b94e25b9efe6b05.js.LICENSE.txt */
function _regenerator(){var e,n,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",a=t.toStringTag||"@@toStringTag";function r(t,o,a,r){var c=o&&o.prototype instanceof i?o:i,l=Object.create(c.prototype);return _regeneratorDefine2(l,"_invoke",function(t,o,a){var r,i,c,l=0,u=a||[],d=!1,m={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(n,t){return r=n,i=0,c=e,m.n=t,s}};function p(t,o){for(i=t,c=o,n=0;!d&&l&&!a&&n<u.length;n++){var a,r=u[n],p=m.p,f=r[2];t>3?(a=f===o)&&(c=r[(i=r[4])?5:(i=3,3)],r[4]=r[5]=e):r[0]<=p&&((a=t<2&&p<r[1])?(i=0,m.v=o,m.n=r[1]):p<f&&(a=t<3||r[0]>o||o>f)&&(r[4]=t,r[5]=o,m.n=f,i=0))}if(a||t>1)return s;throw d=!0,o}return function(a,u,f){if(l>1)throw TypeError("Generator is already running");for(d&&1===u&&p(u,f),i=u,c=f;(n=i<2?e:c)||!d;){r||(i?i<3?(i>1&&(m.n=-1),p(i,c)):m.n=c:m.v=c);try{if(l=2,r){if(i||(a="next"),n=r[a]){if(!(n=n.call(r,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,i<2&&(i=0)}else 1===i&&(n=r.return)&&n.call(r),i<2&&(c=TypeError("The iterator does not provide a '"+a+"' method"),i=1);r=e}else if((n=(d=m.n<0)?c:t.call(o,m))!==s)break}catch(n){r=e,i=1,c=n}finally{l=1}}return{value:n,done:d}}}(t,a,r),!0),l}var s={};function i(){}function c(){}function l(){}n=Object.getPrototypeOf;var u=[][o]?n(n([][o]())):(_regeneratorDefine2(n={},o,function(){return this}),n),d=l.prototype=i.prototype=Object.create(u);function m(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,_regeneratorDefine2(e,a,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=l,_regeneratorDefine2(d,"constructor",l),_regeneratorDefine2(l,"constructor",c),c.displayName="GeneratorFunction",_regeneratorDefine2(l,a,"GeneratorFunction"),_regeneratorDefine2(d),_regeneratorDefine2(d,a,"Generator"),_regeneratorDefine2(d,o,function(){return this}),_regeneratorDefine2(d,"toString",function(){return"[object Generator]"}),(_regenerator=function(){return{w:r,m:m}})()}function _regeneratorDefine2(e,n,t,o){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}_regeneratorDefine2=function(e,n,t,o){function r(n,t){_regeneratorDefine2(e,n,function(e){return this._invoke(n,t,e)})}n?a?a(e,n,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[n]=t:(r("next",0),r("throw",1),r("return",2))},_regeneratorDefine2(e,n,t,o)}function _slicedToArray(e,n){return _arrayWithHoles(e)||_iterableToArrayLimit(e,n)||_unsupportedIterableToArray(e,n)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,n){if(e){if("string"==typeof e)return _arrayLikeToArray(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,n):void 0}}function _arrayLikeToArray(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,o=Array(n);t<n;t++)o[t]=e[t];return o}function _iterableToArrayLimit(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var o,a,r,s,i=[],c=!0,l=!1;try{if(r=(t=t.call(e)).next,0===n){if(Object(t)!==t)return;c=!1}else for(;!(c=(o=r.call(t)).done)&&(i.push(o.value),i.length!==n);c=!0);}catch(e){l=!0,a=e}finally{try{if(!c&&null!=t.return&&(s=t.return(),Object(s)!==s))return}finally{if(l)throw a}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function ownKeys(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,o)}return t}function _objectSpread(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?ownKeys(Object(t),!0).forEach(function(n){_defineProperty(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function _defineProperty(e,n,t){return(n=_toPropertyKey(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function _toPropertyKey(e){var n=_toPrimitive(e,"string");return"symbol"==_typeof(n)?n:n+""}function _toPrimitive(e,n){if("object"!=_typeof(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var o=t.call(e,n||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}function asyncGeneratorStep(e,n,t,o,a,r,s){try{var i=e[r](s),c=i.value}catch(e){return void t(e)}i.done?n(c):Promise.resolve(c).then(o,a)}function _asyncToGenerator(e){return function(){var n=this,t=arguments;return new Promise(function(o,a){var r=e.apply(n,t);function s(e){asyncGeneratorStep(r,o,a,s,i,"next",e)}function i(e){asyncGeneratorStep(r,o,a,s,i,"throw",e)}s(void 0)})}}function initProjectSelectionLogic(){document.querySelectorAll("[data-requires-count]").forEach(function(e){e.addEventListener("change",function(){var e=this.getAttribute("data-requires-count"),n=document.getElementById("".concat(e,"-container"));if(n)if(this.checked){n.style.display="flex";var t=n.querySelector(".count-input");t&&setTimeout(function(){return t.focus()},300)}else{n.style.display="none";var o=n.querySelector(".count-input");o&&(o.value="")}})})}function collectProjectSelectionDetails(){var e={};return document.querySelectorAll(".ms-CheckBox-input").forEach(function(n){if(n.checked){var t=n.parentElement.querySelector(".ms-CheckBox-text").textContent.trim(),o=null,a=n.getAttribute("data-requires-count");if(a){var r=document.getElementById("".concat(a,"-count"));r&&r.value&&(o=parseInt(r.value))}e[t]=o}}),{projectSelectionDetails:e}}function saveProjectSelectionDetails(){return _saveProjectSelectionDetails.apply(this,arguments)}function _saveProjectSelectionDetails(){return(_saveProjectSelectionDetails=_asyncToGenerator(_regenerator().m(function e(){var n,t,o,a,r,s;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,n=moduleConfig.getCurrentDocumentId()){e.n=1;break}return console.warn("没有当前文档ID，跳过保存项目选择详情"),e.a(2);case 1:if(t=collectProjectSelectionDetails(),o=t.projectSelectionDetails,0!==Object.keys(o).length){e.n=2;break}return console.log("没有项目选择，跳过保存"),e.a(2);case 2:return e.n=3,fetch("".concat(moduleConfig.API_BASE_URL,"/api/documents/").concat(n,"/project-selection"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectSelectionDetails:_objectSpread(_objectSpread({},o),{},{lastUpdated:(new Date).toISOString()})})});case 3:if((a=e.v).ok){e.n=4;break}throw new Error("保存项目选择失败: ".concat(a.statusText));case 4:return e.n=5,a.json();case 5:r=e.v,console.log("✅ 项目选择详情已保存:",r),e.n=7;break;case 6:throw e.p=6,s=e.v,console.error("❌ 保存项目选择详情时出错:",s),s;case 7:return e.a(2)}},e,null,[[0,6]])}))).apply(this,arguments)}function createStandardCostAnalysisHeaders(){return _createStandardCostAnalysisHeaders.apply(this,arguments)}function _createStandardCostAnalysisHeaders(){return _createStandardCostAnalysisHeaders=_asyncToGenerator(_regenerator().m(function e(){var n;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(n){var t,o,a;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return t=n.workbook.worksheets.getActiveWorksheet(),o=["Task","Unit","Cost Per Hour","# of Hours Per Unit","Cost Per Unit","Estimated cost","Notes"],(a=t.getRange("A1:G1")).values=[o],a.format.font.bold=!0,a.format.font.size=12,a.format.fill.color="#E7E7E7",a.format.borders.getItem("EdgeTop").style="Continuous",a.format.borders.getItem("EdgeBottom").style="Continuous",a.format.borders.getItem("EdgeLeft").style="Continuous",a.format.borders.getItem("EdgeRight").style="Continuous",a.format.borders.getItem("InsideVertical").style="Continuous",a.format.autofitColumns(),e.n=1,n.sync();case 1:console.log("✅ 标准成本分析表格标题已创建"),moduleConfig.showStatusMessage("Excel table headers created successfully!","success");case 2:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 1:e.n=3;break;case 2:e.p=2,n=e.v,console.error("❌ 创建Excel标题时出错:",n),moduleConfig.showStatusMessage("Failed to create Excel headers: "+n.message,"error");case 3:return e.a(2)}},e,null,[[0,2]])})),_createStandardCostAnalysisHeaders.apply(this,arguments)}function populateExcelWithSelectedProjects(){return _populateExcelWithSelectedProjects.apply(this,arguments)}function _populateExcelWithSelectedProjects(){return _populateExcelWithSelectedProjects=_asyncToGenerator(_regenerator().m(function e(){var n,t,o,a,r,s,i,c,l,u,d=arguments;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=d.length>0&&void 0!==d[0]?d[0]:null,e.p=1,t={},!n){e.n=2;break}t=n,console.log("✅ 使用传入的项目选择数据"),e.n=9;break;case 2:if(!(o=moduleConfig.getCurrentDocumentId())){e.n=8;break}return e.p=3,e.n=4,fetch("".concat(moduleConfig.API_BASE_URL,"/api/documents/").concat(o,"/content"));case 4:if(!(a=e.v).ok){e.n=6;break}return e.n=5,a.json();case 5:(s=e.v).document&&null!==(r=s.document.CostEstimateDetails)&&void 0!==r&&null!==(r=r.projectSelection)&&void 0!==r&&r.selectionDetails&&(t=s.document.CostEstimateDetails.projectSelection.selectionDetails);case 6:e.n=8;break;case 7:e.p=7,l=e.v,console.warn("无法获取已保存的项目详情，使用当前选择:",l);case 8:if(0!==Object.keys(t).length){e.n=9;break}if(console.log("📋 从UI收集项目选择详情..."),i=collectProjectSelectionDetails(),c=i.projectSelectionDetails,t=c,0!==Object.keys(t).length){e.n=9;break}return console.warn("⚠️ 无法获取项目选择数据，Excel表格将为空"),moduleConfig.showStatusMessage("No project selection data available","warning"),e.a(2);case 9:return console.log("🔍 [DEBUG] 项目选择详情:",t),e.n=10,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(n){var o,a,r,s,i,c,l,u,d,m,p,f,g,v,y,h,b,D,S,x,T,C,E,M,w,P,k,_,A,B,U,j,I,R,L,H,G,F,O,N,z,q,V,W,$,K,J,X,Y,Q,Z,ee,ne,te,oe,ae,re;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:if(o=n.workbook.worksheets.getActiveWorksheet(),a=2,!(Object.keys(t).length>0)){e.n=4;break}r=0,s=Object.entries(t);case 1:if(!(r<s.length)){e.n=4;break}if(i=_slicedToArray(s[r],2),c=i[0],l=i[1],"lastUpdated"!==c){e.n=2;break}return e.a(3,3);case 2:if(u=c.toLowerCase().includes("sdtm"),d=c.toLowerCase().includes("adam"),m=c.toLowerCase().includes("dsur"),p=c.toLowerCase().includes("dsmb"),f=c.toLowerCase().includes("statistical analysis plan"),u||d||f){if((g=o.getRange("A".concat(a,":G").concat(a))).values=[[c,"","","","","",""]],g.format.font.bold=!0,g.format.horizontalAlignment="Left",a++,v=a-1,u)for(y=0,h=[{name:"SDTM Annotated CRFs (aCRF)",unit:"",costPerHour:1,hoursPerUnit:32,costPerUnit:32},{name:"SDTM Dataset Specs (High Complexity)",unit:"",costPerHour:1,hoursPerUnit:3,costPerUnit:3},{name:"SDTM Dataset Specs (Medium Complexity)",unit:"",costPerHour:1,hoursPerUnit:2,costPerUnit:2},{name:"SDTM Production and Validation: Programs and Datasets (High Complexity)",unit:"",costPerHour:1,hoursPerUnit:16,costPerUnit:16},{name:"SDTM Production and Validation: Programs and Datasets (Medium Complexity)",unit:"",costPerHour:1,hoursPerUnit:10,costPerUnit:10},{name:"SDTM Pinnacle 21 Report Creation and Review",unit:"",costPerHour:1,hoursPerUnit:6,costPerUnit:6},{name:"SDTM Reviewer's Guide",unit:"",costPerHour:1,hoursPerUnit:32,costPerUnit:32},{name:"SDTM Define.xml",unit:"",costPerHour:1,hoursPerUnit:32,costPerUnit:32},{name:"SDTM Dataset File xpt Conversion and Review",unit:"",costPerHour:1,hoursPerUnit:.2,costPerUnit:.2}];y<h.length;y++)b=h[y],(D=o.getRange("A".concat(a,":G").concat(a))).values=[[b.name,"","$".concat(b.costPerHour),b.hoursPerUnit,"","",""]],(S=o.getRange("E".concat(a))).formulas=[["=C".concat(a,"*D").concat(a)]],S.format.numberFormat=[["$#,##0.00"]],(x=o.getRange("F".concat(a))).formulas=[["=B".concat(a,"*C").concat(a,"*D").concat(a)]],x.format.numberFormat=[["$#,##0.00"]],D.format.font.bold=!1,D.format.horizontalAlignment="Left",o.getRange("B".concat(a,":F").concat(a)).format.horizontalAlignment="Right",a++;else if(d)for(T=0,C=[{name:"ADaM Dataset Specs (High Complexity)",unit:"",costPerHour:1,hoursPerUnit:3,costPerUnit:3},{name:"ADaM Dataset Specs (Medium Complexity)",unit:"",costPerHour:1,hoursPerUnit:2,costPerUnit:2},{name:"ADaM Production and Validation: Programs and Datasets (High Complexity)",unit:"",costPerHour:1,hoursPerUnit:18,costPerUnit:18},{name:"ADaM Production and Validation: Programs and Datasets (Medium Complexity)",unit:"",costPerHour:1,hoursPerUnit:10,costPerUnit:10},{name:"ADaM Pinnacle 21 Report Creation and Review",unit:"",costPerHour:1,hoursPerUnit:4,costPerUnit:4},{name:"ADaM Reviewer's Guide",unit:"",costPerHour:1,hoursPerUnit:32,costPerUnit:32},{name:"ADaM Define.xml",unit:"",costPerHour:1,hoursPerUnit:32,costPerUnit:32},{name:"ADaM Dataset Program xpt Conversion and Review",unit:"",costPerHour:1,hoursPerUnit:.2,costPerUnit:.2},{name:"ADaM Program txt Conversion and Review",unit:"",costPerHour:1,hoursPerUnit:.2,costPerUnit:.2}];T<C.length;T++)E=C[T],(M=o.getRange("A".concat(a,":G").concat(a))).values=[[E.name,"","$".concat(E.costPerHour),E.hoursPerUnit,"","",""]],(w=o.getRange("E".concat(a))).formulas=[["=C".concat(a,"*D").concat(a)]],w.format.numberFormat=[["$#,##0.00"]],(P=o.getRange("F".concat(a))).formulas=[["=B".concat(a,"*C").concat(a,"*D").concat(a)]],P.format.numberFormat=[["$#,##0.00"]],M.format.font.bold=!1,M.format.horizontalAlignment="Left",o.getRange("B".concat(a,":F").concat(a)).format.horizontalAlignment="Right",a++;else if(f)for(k=0,_=[{name:"Statistical Analysis Plan Draft 1",unit:"",costPerHour:1,hoursPerUnit:40,costPerUnit:40},{name:"Statistical Analysis Plan Draft 2",unit:"",costPerHour:1,hoursPerUnit:30,costPerUnit:30},{name:"Statistical Analysis Plan Final",unit:"",costPerHour:1,hoursPerUnit:20,costPerUnit:20},{name:"Analysis Shells Development",unit:"",costPerHour:1,hoursPerUnit:60,costPerUnit:60},{name:"Mock Tables, Listings, and Figures",unit:"",costPerHour:1,hoursPerUnit:40,costPerUnit:40}];k<_.length;k++)A=_[k],(B=o.getRange("A".concat(a,":G").concat(a))).values=[[A.name,"","$".concat(A.costPerHour),A.hoursPerUnit,"","",""]],(U=o.getRange("E".concat(a))).formulas=[["=C".concat(a,"*D").concat(a)]],U.format.numberFormat=[["$#,##0.00"]],(j=o.getRange("F".concat(a))).formulas=[["=B".concat(a,"*C").concat(a,"*D").concat(a)]],j.format.numberFormat=[["$#,##0.00"]],B.format.font.bold=!1,B.format.horizontalAlignment="Left",o.getRange("B".concat(a,":F").concat(a)).format.horizontalAlignment="Right",a++;if((I=o.getRange("A".concat(a,":G").concat(a))).values=[["Subtotal","","","","","",""]],R=a-1,L=v+1,(H=o.getRange("F".concat(a))).formulas=[["=SUM(F".concat(L,":F").concat(R,")")]],H.format.numberFormat=[["$#,##0.00"]],H.format.font.bold=!0,I.format.font.bold=!0,I.format.horizontalAlignment="Right",a++,l&&l>0&&(u||d)){for(G=u?"SDTM Dataset Transfer (".concat(l," times)"):"ADAM Dataset Transfer (".concat(l," times)"),(F=o.getRange("A".concat(a,":G").concat(a))).values=[[G,"","","","","",""]],F.format.font.bold=!0,F.format.horizontalAlignment="Left",a++,O=u?[{name:"Production and Validation, the first 2 times",unit:2,costPerHour:1,hoursPerUnit:25,costPerUnit:25},{name:"Production and Validation, the last ".concat(l-2," times"),unit:l-2,costPerHour:1,hoursPerUnit:12.5,costPerUnit:12.5}]:[{name:"Production and Validation, the first 2 times",unit:2,costPerHour:1,hoursPerUnit:15,costPerUnit:15},{name:"Production and Validation, the last ".concat(l-2," times"),unit:l-2,costPerHour:1,hoursPerUnit:7.5,costPerUnit:7.5}],N=0,z=O;N<z.length;N++)q=z[N],(V=o.getRange("A".concat(a,":G").concat(a))).values=[[q.name,q.unit,"$".concat(q.costPerHour),q.hoursPerUnit,"","",""]],(W=o.getRange("E".concat(a))).formulas=[["=C".concat(a,"*D").concat(a)]],W.format.numberFormat=[["$#,##0.00"]],($=o.getRange("F".concat(a))).formulas=[["=B".concat(a,"*C").concat(a,"*D").concat(a)]],$.format.numberFormat=[["$#,##0.00"]],V.format.font.bold=!1,V.format.horizontalAlignment="Left",o.getRange("B".concat(a,":F").concat(a)).format.horizontalAlignment="Right",a++;(K=o.getRange("A".concat(a,":G").concat(a))).values=[["Subtotal","","","","","",""]],K.format.font.bold=!0,K.format.horizontalAlignment="Right",a++}}else m||p?l&&l>0&&(J=m?"DSUR Rerun (".concat(l," times)"):"DSMB Rerun (".concat(l," times)"),(X=o.getRange("A".concat(a,":G").concat(a))).values=[[J,"","","","","",""]],X.format.font.bold=!0,X.format.horizontalAlignment="Left",a++,(Y=o.getRange("A".concat(a,":G").concat(a))).values=[["Subtotal","","","","","",""]],Y.format.font.bold=!0,Y.format.horizontalAlignment="Right",a++):((Q=o.getRange("A".concat(a,":G").concat(a))).values=[[c,"","","","","",""]],Q.format.font.bold=!0,Q.format.horizontalAlignment="Left",a++,(Z=o.getRange("A".concat(a,":G").concat(a))).values=[["Subtotal","","","","","",""]],Z.format.font.bold=!0,Z.format.horizontalAlignment="Right",a++);case 3:r++,e.n=1;break;case 4:for(ee=0,ne=["License Fees","Adhoc Analysis","Project Management/Administration(12 Months)"];ee<ne.length;ee++)te=ne[ee],(oe=o.getRange("A".concat(a,":G").concat(a))).values=[[te,"","","","","",""]],oe.format.font.bold=!0,oe.format.horizontalAlignment="Left",a++,(ae=o.getRange("A".concat(a,":G").concat(a))).values=[["Subtotal","","","","","",""]],ae.format.font.bold=!0,ae.format.horizontalAlignment="Right",a++;return(re=o.getRange("A".concat(a,":G").concat(a))).values=[["Grand Total","","","","","",""]],re.format.font.bold=!0,re.format.horizontalAlignment="Right",e.n=5,n.sync();case 5:console.log("✅ Excel项目列表已填充完成（完整逻辑）"),moduleConfig.showStatusMessage("Excel table populated successfully!","success");case 6:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 10:e.n=12;break;case 11:e.p=11,u=e.v,console.error("❌ 填充Excel项目列表时出错:",u),moduleConfig.showStatusMessage("Failed to populate Excel: "+u.message,"error");case 12:return e.a(2)}},e,null,[[3,7],[1,11]])})),_populateExcelWithSelectedProjects.apply(this,arguments)}function displaySDTMAnalysis(e){var n,t,o,a;if(console.log("🔍 [DEBUG] 显示SDTM分析结果:",e),e&&e.procedures){window.currentSDTMData=_objectSpread(_objectSpread({},e),{},{mappings:e.mappings?convertMapToMappingsList(e.mappings,e.procedures):(e.procedures||[]).map(function(e){return{procedure:e,sdtm_domains:[]}})});var r=(null===(n=e.procedures)||void 0===n?void 0:n.length)||0,s=(null===(t=e.summary)||void 0===t?void 0:t.unique_domains)||[],i=s.length;console.log("🔍 [DEBUG] 统计信息:",{totalProcedures:r,totalDomains:i,uniqueDomains:s});var c=document.getElementById("total-procedures"),l=document.getElementById("total-domains");c?(c.textContent=r,console.log("✅ 已更新procedures count:",r)):console.error("❌ 找不到 total-procedures 元素"),l?(l.textContent=i,console.log("✅ 已更新domains count:",i)):console.error("❌ 找不到 total-domains 元素");var u=document.getElementById("domains-list-overview");u?(u.innerHTML=s.map(function(e){return'<span class="domain-tag">'.concat(e,"</span>")}).join(""),console.log("✅ 已更新域概览")):console.error("❌ 找不到 domains-list-overview 元素");var d=document.getElementById("high-complexity-domains"),m=document.getElementById("medium-complexity-domains");d&&null!==(o=e.summary)&&void 0!==o&&null!==(o=o.highComplexitySdtm)&&void 0!==o&&o.domains&&(d.innerHTML=e.summary.highComplexitySdtm.domains.map(function(e){return'<span class="domain-tag">'.concat(e,"</span>")}).join(""),console.log("✅ 已更新高复杂度域")),m&&null!==(a=e.summary)&&void 0!==a&&null!==(a=a.mediumComplexitySdtm)&&void 0!==a&&a.domains&&(m.innerHTML=e.summary.mediumComplexitySdtm.domains.map(function(e){return'<span class="domain-tag">'.concat(e,"</span>")}).join(""),console.log("✅ 已更新中等复杂度域")),console.log("🔍 [DEBUG] 开始显示映射列表..."),displayFlatMappingsList(window.currentSDTMData.mappings);var p=document.getElementById("sdtm-mappings-container");p?(p.style.display="block",console.log("✅ 已显示映射容器"),bindSDTMButtonEvents()):console.error("❌ 找不到 sdtm-mappings-container 元素")}else console.warn("❌ No SDTM analysis data to display")}var isEditMode=!1;function convertMapToMappingsList(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(console.log("🔍 [DEBUG] 转换Map格式mappings:",e),!e)return[];var t=[];return e instanceof Map?e.forEach(function(e,n){var o=e?e.split(",").map(function(e){return e.trim()}).filter(function(e){return e}):[];t.push({procedure:n,sdtm_domains:o})}):"object"===_typeof(e)&&Object.entries(e).forEach(function(e){var n=_slicedToArray(e,2),o=n[0],a=n[1],r=[];"string"==typeof a?r=a.split(",").map(function(e){return e.trim()}).filter(function(e){return e}):Array.isArray(a)&&(r=a),t.push({procedure:o,sdtm_domains:r})}),0===t.length&&n&&n.length>0&&n.forEach(function(e){t.push({procedure:e,sdtm_domains:[]})}),console.log("✅ 转换后的mappings列表:",t),t}function toggleEditMode(){console.log("🔍 [DEBUG] 切换编辑模式，当前状态:",isEditMode);var e=document.getElementById("edit-mappings-btn"),n=document.getElementById("confirm-mappings-btn"),t=document.querySelectorAll(".flat-mapping-item");isEditMode?(isEditMode=!1,e.textContent="Edit",e.style.backgroundColor="#007bff",n.style.display="inline-block",t.forEach(function(e,n){makeItemReadOnly(e,n)}),console.log("✅ 退出编辑模式")):(isEditMode=!0,e.textContent="Cancel Edit",e.style.backgroundColor="#dc3545",n.style.display="none",t.forEach(function(e,n){makeItemEditable(e,n)}),console.log("✅ 进入编辑模式"))}function makeItemEditable(e,n){e.querySelectorAll(".domain-tag").forEach(function(e,t){if(e.className="editable-domain-tag",e.dataset.mappingIndex=n,e.dataset.domainIndex=t,!e.querySelector(".remove-domain-btn")){var o=document.createElement("span");o.className="remove-domain-btn",o.innerHTML="×",o.addEventListener("click",function(n){n.stopPropagation(),removeDomainTag(e)}),e.appendChild(o)}e.addEventListener("click",function(){makeTagEditable(e)}),e.style.cssText="\n      background: #e6f3ff;\n      color: #0078d7;\n      padding: 4px 8px;\n      border-radius: 12px;\n      font-size: 11px;\n      font-weight: 500;\n      border: 1px solid #b3d9ff;\n      position: relative;\n      display: inline-flex;\n      align-items: center;\n      gap: 4px;\n      cursor: text;\n      min-width: 30px;\n      margin: 1px;\n      transition: all 0.2s ease;\n    "})}function makeItemReadOnly(e,n){e.querySelectorAll(".editable-domain-tag").forEach(function(n){var t=n.querySelector(".remove-domain-btn");t&&t.remove(),n.replaceWith(n.cloneNode(!0));var o=e.querySelector(".editable-domain-tag");if(o){o.className="domain-tag";var a=o.textContent.trim();o.style.cssText=a&&"No Mapping"!==a?"\n          background: #e3f2fd;\n          color: #1976d2;\n          padding: 2px 6px;\n          border-radius: 3px;\n          font-size: 11px;\n          margin: 1px;\n          display: inline-block;\n        ":"\n          background: #f5f5f5;\n          color: #666;\n          padding: 2px 6px;\n          border-radius: 3px;\n          font-size: 11px;\n          margin: 1px;\n          display: inline-block;\n          font-style: italic;\n        "}})}function makeTagEditable(e){if("true"!==e.contentEditable){var n=e.textContent.replace("×","").trim();e.innerHTML=n,e.contentEditable="true",e.classList.add("editing"),e.focus();var t=document.createRange();t.selectNodeContents(e);var o=window.getSelection();o.removeAllRanges(),o.addRange(t),e.style.cssText+="\n    background-color: white !important;\n    border-color: #0078d7 !important;\n    box-shadow: 0 0 0 2px rgba(0, 120, 215, 0.3) !important;\n    outline: none !important;\n  ";var a=function(){e.contentEditable="false",e.classList.remove("editing");var t=e.textContent.trim(),o=parseInt(e.dataset.mappingIndex),a=parseInt(e.dataset.domainIndex);console.log("🔍 [DEBUG] 编辑完成: ".concat(n," → ").concat(t)),t&&window.currentSDTMData&&window.currentSDTMData.mappings[o]&&(window.currentSDTMData.mappings[o].sdtm_domains[a]=t,console.log("✅ 已更新SDTM数据"));var r=createEditableDomainTag(t,o,a);e.parentNode.replaceChild(r,e)};e.addEventListener("blur",a),e.addEventListener("keydown",function(t){"Enter"===t.key?(t.preventDefault(),a()):"Escape"===t.key&&(t.preventDefault(),e.textContent=n,a())})}}function createEditableDomainTag(e,n,t){var o=document.createElement("span");o.className="editable-domain-tag",o.textContent=e,o.dataset.mappingIndex=n,o.dataset.domainIndex=t;var a=document.createElement("span");return a.className="remove-domain-btn",a.innerHTML="×",a.addEventListener("click",function(e){e.stopPropagation(),removeDomainTag(o)}),o.appendChild(a),o.addEventListener("click",function(){isEditMode&&makeTagEditable(o)}),o.style.cssText="\n    background: #e6f3ff;\n    color: #0078d7;\n    padding: 4px 8px;\n    border-radius: 12px;\n    font-size: 11px;\n    font-weight: 500;\n    border: 1px solid #b3d9ff;\n    position: relative;\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    cursor: text;\n    min-width: 30px;\n    margin: 1px;\n    transition: all 0.2s ease;\n  ",o}function removeDomainTag(e){var n=parseInt(e.dataset.mappingIndex),t=parseInt(e.dataset.domainIndex);console.log("🔍 [DEBUG] 删除域标签: mapping=".concat(n,", domain=").concat(t)),window.currentSDTMData&&window.currentSDTMData.mappings[n]&&(window.currentSDTMData.mappings[n].sdtm_domains.splice(t,1),console.log("✅ 已从SDTM数据中删除")),e.remove(),window.currentSDTMData&&displayFlatMappingsList(window.currentSDTMData.mappings)}var handleEditMappings=function(){console.log("🔍 [DEBUG] Edit按钮被点击"),toggleEditMode()};function bindSDTMButtonEvents(){console.log("🔍 [DEBUG] 开始绑定SDTM按钮事件...");var e=document.getElementById("edit-mappings-btn"),n=document.getElementById("confirm-mappings-btn");e?(e.onclick=function(){console.log("🔍 [DEBUG] Edit按钮被点击 (内联处理)");try{toggleEditMode()}catch(e){console.error("❌ Edit按钮处理出错:",e),alert("Edit button error: "+e.message)}},console.log("✅ Edit按钮事件已绑定")):console.error("❌ 找不到 edit-mappings-btn 元素"),n?(n.onclick=function(){console.log("🔍 [DEBUG] Confirm & Save按钮被点击 (内联处理)");try{window.CostEstimateModule.confirmSDTMAnalysis()}catch(e){console.error("❌ Confirm按钮处理出错:",e),alert("Confirm button error: "+e.message)}},console.log("✅ Confirm & Save按钮事件已绑定")):console.error("❌ 找不到 confirm-mappings-btn 元素")}function displayFlatMappingsList(e){console.log("🔍 [DEBUG] displayFlatMappingsList 调用，mappingsData:",e);var n=document.getElementById("flat-mappings-list");if(n){if(n.innerHTML="",console.log("✅ 已清空映射列表容器"),!e||0===e.length)return console.warn("⚠️ 没有mappings数据可显示"),void(n.innerHTML="<p>No procedure mappings available.</p>");var t=[];if("string"==typeof e[0])console.log("🔍 [DEBUG] 检测到字符串数组，转换为映射格式"),t=e.map(function(e){return{procedure:e,sdtm_domains:[]}});else{if("object"!==_typeof(e[0])||!e[0].procedure)return console.error("❌ 无法识别的数据格式:",e[0]),void(n.innerHTML="<p>Invalid mapping data format.</p>");console.log("🔍 [DEBUG] 检测到对象数组，直接使用"),t=e}t.forEach(function(e,t){console.log("🔍 [DEBUG] 处理第".concat(t+1,"个mapping:"),e);var o=document.createElement("div");o.className="flat-mapping-item";var a=e.procedure||"Unknown Procedure",r=e.sdtm_domains||[];o.innerHTML='\n      <div class="flat-procedure-name"><strong>'.concat(a,':</strong></div>\n      <div class="flat-domain-tags">\n        ').concat(r.map(function(e){return'<span class="domain-tag">'.concat(e,"</span>")}).join(""),"\n      </div>\n    "),n.appendChild(o)}),console.log("✅ 已显示 ".concat(t.length," 个映射项"))}else console.error("❌ 找不到 flat-mappings-list 元素")}function collectCurrentMappings(){console.log("🔍 [DEBUG] 收集当前映射数据...");var e=document.querySelectorAll(".flat-mapping-item"),n=[];return e.forEach(function(e,t){var o=e.querySelector("strong"),a=e.querySelectorAll(".domain-tag, .editable-domain-tag, .domain-edit-select");if(o){var r=o.textContent.trim().replace(":",""),s=[];a.forEach(function(e){var n;(n="SELECT"===e.tagName?e.value:(n=e.textContent.trim()).replace("×","").trim())&&"No Mapping"!==n&&s.push(n)}),n.push({procedure:r,sdtm_domains:s}),console.log("📋 映射 ".concat(t+1,": ").concat(r," → [").concat(s.join(", "),"]"))}}),console.log("✅ 收集到的映射数据总数:",n.length),n}function confirmSDTMAnalysis(){return _confirmSDTMAnalysis.apply(this,arguments)}function _confirmSDTMAnalysis(){return(_confirmSDTMAnalysis=_asyncToGenerator(_regenerator().m(function e(){var n,t,o,a,r,s,i,c,l,u,d,m,p,f,g,v;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:if(console.log("🔍 [DEBUG] Confirm & Save按钮被点击"),isEditMode&&(console.log("🔄 退出编辑模式并保存更改..."),toggleEditMode()),n=collectCurrentMappings(),console.log("🔍 [DEBUG] 收集到的更新映射:",n),t=moduleConfig.getCurrentDocumentId(),console.log("🔍 [DEBUG] 当前文档ID:",t),t){e.n=1;break}return console.error("❌ 没有文档ID"),alert("No document ID found. Please re-upload the document."),e.a(2);case 1:if(window.currentSDTMData){e.n=2;break}return console.error("❌ 没有基础SDTM数据"),alert("No SDTM analysis data available to confirm."),e.a(2);case 2:return e.p=2,console.log("🔍 [DEBUG] 开始发送确认请求..."),e.n=3,fetch("".concat(moduleConfig.API_BASE_URL,"/api/documents/").concat(t,"/confirm-sdtm"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({procedures:window.currentSDTMData.procedures||[],mappings:n,summary:window.currentSDTMData.summary||{}})});case 3:if(a=e.v,console.log("🔍 [DEBUG] API响应状态:",a.status),a.ok){e.n=5;break}return e.n=4,a.text();case 4:throw r=e.v,console.error("❌ API响应错误:",r),new Error("确认SDTM失败: ".concat(a.statusText));case 5:return e.n=6,a.json();case 6:if(s=e.v,console.log("✅ SDTM分析已确认:",s),window.currentSDTMData=_objectSpread(_objectSpread({},window.currentSDTMData),{},{mappings:n}),(i=document.getElementById("confirmation-status"))&&(i.style.display="flex"),c=document.getElementById("edit-mappings-btn"),l=document.getElementById("confirm-mappings-btn"),c&&(c.disabled=!0),l&&(l.disabled=!0),moduleConfig.showStatusMessage("SDTM analysis confirmed and saved successfully!","success"),!(u=null==s||null===(o=s.data)||void 0===o?void 0:o.costEstimate)||!u["SDTM Datasets Production and Validation"]){e.n=8;break}return console.log("🔧 应用Unit、Cost和Notes到Excel..."),e.n=7,applySDTMUnitsAndCostsToExcel(u["SDTM Datasets Production and Validation"]);case 7:console.log("✅ Unit、Cost和Notes已同步填入Excel"),e.n=14;break;case 8:return console.warn("⚠️ 没有收到costEstimate数据，尝试从文档获取..."),e.p=9,e.n=10,fetch("".concat(moduleConfig.API_BASE_URL,"/api/documents/").concat(t,"/content"));case 10:if(!(d=e.v).ok){e.n=12;break}return e.n=11,d.json();case 11:if(p=e.v,!(f=null==p||null===(m=p.document)||void 0===m||null===(m=m.CostEstimateDetails)||void 0===m||null===(m=m.sdtmTableInput)||void 0===m?void 0:m["SDTM Datasets Production and Validation"])){e.n=12;break}return console.log("🔧 使用文档中的快照数据..."),e.n=12,applySDTMUnitsAndCostsToExcel(f);case 12:e.n=14;break;case 13:e.p=13,g=e.v,console.warn("无法从文档获取数据:",g);case 14:setTimeout(function(){moduleConfig.showStep(6)},2e3),e.n=16;break;case 15:e.p=15,v=e.v,console.error("❌ 确认SDTM分析时出错:",v),moduleConfig.showStatusMessage("Failed to confirm SDTM analysis: "+v.message,"error");case 16:return e.a(2)}},e,null,[[9,13],[2,15]])}))).apply(this,arguments)}function applySDTMUnitsAndCostsToExcel(e){return _applySDTMUnitsAndCostsToExcel.apply(this,arguments)}function _applySDTMUnitsAndCostsToExcel(){return _applySDTMUnitsAndCostsToExcel=_asyncToGenerator(_regenerator().m(function e(n){var t,o;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:return t={"SDTM Annotated CRFs (aCRF)":"annotatedCrf","SDTM Dataset Specs (High Complexity)":"specsHigh","SDTM Dataset Specs (Medium Complexity)":"specsMedium","SDTM Production and Validation: Programs and Datasets (High Complexity)":"prodHigh","SDTM Production and Validation: Programs and Datasets (Medium Complexity)":"prodMedium","SDTM Pinnacle 21 Report Creation and Review":"pinnacle21","SDTM Reviewer's Guide":"reviewersGuide","SDTM Define.xml":"defineXml","SDTM Dataset File xpt Conversion and Review":"xptConversion"},e.p=1,e.n=2,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(o){var a,r,s,i,c,l,u,d,m,p,f,g,v,y,h,b,D,S,x,T,C,E,M,w,P,k;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return r=o.workbook.worksheets.getActiveWorksheet(),(s=r.getUsedRange()).load(["values","rowIndex","columnIndex"]),e.n=1,o.sync();case 1:i=s.rowIndex||0,c=s.columnIndex||0,l=s.values,u=n.units||{},d=n.estimatedCosts||{},m=n.notes||{},p=null!==(a=n.subtotal)&&void 0!==a?a:null,console.log("🔍 [DEBUG] SDTM快照数据:",{units:u,costs:d,notes:m,subtotal:p}),f=0;case 2:if(!(f<l.length)){e.n=5;break}if(v=String(l[f][0]||"").trim(),t.hasOwnProperty(v)){e.n=3;break}return e.a(3,4);case 3:y=t[v],h=null!==(g=u[y])&&void 0!==g?g:"",b=r.getRangeByIndexes(i+f,c+1,1,1),D=r.getRangeByIndexes(i+f,c+5,1,1),b.values=[[""===h?"":Number(h)]],b.format.horizontalAlignment="Right",""!==h?(S=i+f+1,D.formulas=[["=B".concat(S,"*C").concat(S,"*D").concat(S)]],D.format.numberFormat=[["$#,##0.00"]],D.format.horizontalAlignment="Right",console.log("✅ 已设置 ".concat(v,": Unit=").concat(h,", 公式=B").concat(S,"*C").concat(S,"*D").concat(S))):D.values=[[""]],x=t[v],m[x]&&((T=r.getRangeByIndexes(i+f,c+6,1,1)).values=[[m[x]]],T.format.horizontalAlignment="Left",console.log("✅ 已设置 ".concat(v," 的 Notes: ").concat(m[x])));case 4:f++,e.n=2;break;case 5:C=-1,E=0;case 6:if(!(E<l.length)){e.n=8;break}if("sdtm datasets production and validation"!==String(l[E][0]||"").trim().toLowerCase()){e.n=7;break}return C=E,e.a(3,8);case 7:E++,e.n=6;break;case 8:if(!(C>=0)){e.n=11;break}M=C+1;case 9:if(!(M<l.length)){e.n=11;break}if("subtotal"!==String(l[M][0]||"").trim().toLowerCase()){e.n=10;break}return w=r.getRangeByIndexes(i+M,c+5,1,1),P=i+C+2,k=i+M+1-1,w.formulas=[["=SUM(F".concat(P,":F").concat(k,")")]],w.format.numberFormat=[["$#,##0.00"]],w.format.horizontalAlignment="Right",w.format.font.bold=!0,console.log("✅ 已设置Subtotal公式: =SUM(F".concat(P,":F").concat(k,")")),e.a(3,11);case 10:M++,e.n=9;break;case 11:return e.n=12,o.sync();case 12:moduleConfig.showStatusMessage("Units, estimated costs and subtotal applied from confirmed SDTM data.","success");case 13:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 2:e.n=4;break;case 3:e.p=3,o=e.v,console.error("Failed to write SDTM units and costs:",o),moduleConfig.showStatusMessage("Failed to write units/costs/subtotal to Excel: "+o.message,"error");case 4:return e.a(2)}},e,null,[[1,3]])})),_applySDTMUnitsAndCostsToExcel.apply(this,arguments)}function applySDTMNotesToExcel(e){return _applySDTMNotesToExcel.apply(this,arguments)}function _applySDTMNotesToExcel(){return _applySDTMNotesToExcel=_asyncToGenerator(_regenerator().m(function e(n){var t,o,a,r,s,i,c,l;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,r=(null==n||null===(t=n.summary)||void 0===t||null===(t=t.highComplexitySdtm)||void 0===t?void 0:t.domains)||[],s=(null==n||null===(o=n.summary)||void 0===o||null===(o=o.mediumComplexitySdtm)||void 0===o?void 0:o.domains)||[],i=(null==n||null===(a=n.summary)||void 0===a?void 0:a.unique_domains)||[],c={"SDTM Dataset Specs (High Complexity)":r.join("/"),"SDTM Dataset Specs (Medium Complexity)":s.join("/"),"SDTM Dataset File xpt Conversion and Review":i.join("/")},console.log("🔍 [DEBUG] SDTM Notes映射:",c),e.n=1,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(n){var t,o,a,r,s,i,l,u,d;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return t=n.workbook.worksheets.getActiveWorksheet(),(o=t.getUsedRange()).load(["values","rowIndex","columnIndex"]),e.n=1,n.sync();case 1:a=o.rowIndex||0,r=o.columnIndex||0,s=o.values,i=0;case 2:if(!(i<s.length)){e.n=5;break}if((l=String(s[i][0]||"").trim())in c){e.n=3;break}return e.a(3,4);case 3:u=c[l]||"",(d=t.getRangeByIndexes(a+i,r+6,1,1)).values=[[u]],d.format.horizontalAlignment="Left",console.log("✅ 已设置 ".concat(l," 的 Notes: ").concat(u));case 4:i++,e.n=2;break;case 5:return e.n=6,n.sync();case 6:moduleConfig.showStatusMessage("Notes updated from SDTM confirmed data.","success");case 7:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 1:e.n=3;break;case 2:e.p=2,l=e.v,console.error("Failed to write SDTM notes:",l),moduleConfig.showStatusMessage("Failed to write SDTM notes: "+l.message,"error");case 3:return e.a(2)}},e,null,[[0,2]])})),_applySDTMNotesToExcel.apply(this,arguments)}function saveExcelChangesToDatabase(){return _saveExcelChangesToDatabase.apply(this,arguments)}function _saveExcelChangesToDatabase(){return _saveExcelChangesToDatabase=_asyncToGenerator(_regenerator().m(function e(){var n,t;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n=moduleConfig.getCurrentDocumentId()){e.n=1;break}return console.warn("⚠️ 没有有效的文档ID，跳过保存"),e.a(2);case 1:return e.p=1,e.n=2,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(t){var o,a,r,s,i,c,l,u,d,m;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return o=t.workbook.worksheets.getActiveWorksheet(),(a=o.getUsedRange()).load(["values","rowIndex","columnIndex"]),e.n=1,t.sync();case 1:for(r=a.values,s={},i=0;i<r.length;i++)c=String(r[i][0]||"").trim(),l=r[i][1],c&&void 0!==l&&""!==l&&(u=getTaskKeyFromName(c))&&(s[u]=Number(l)||0);return console.log("🔍 [DEBUG] 提取的Unit数据:",s),e.n=2,fetch("".concat(moduleConfig.API_BASE_URL,"/api/documents/").concat(n,"/update-units"),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({units:s})});case 2:return d=e.v,e.n=3,d.json();case 3:(m=e.v).success?(console.log("✅ Excel Unit变化已同步到数据库"),moduleConfig.showStatusMessage("Units updated and saved automatically!","success")):console.warn("⚠️ 保存Unit变化失败:",m.message);case 4:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 2:e.n=4;break;case 3:e.p=3,t=e.v,console.error("❌ 保存Excel变化到数据库失败:",t),moduleConfig.showStatusMessage("Failed to save changes: "+t.message,"error");case 4:return e.a(2)}},e,null,[[1,3]])})),_saveExcelChangesToDatabase.apply(this,arguments)}function getTaskKeyFromName(e){return{"SDTM Annotated CRFs (aCRF)":"annotatedCrf","SDTM Dataset Specs (High Complexity)":"specsHigh","SDTM Dataset Specs (Medium Complexity)":"specsMedium","SDTM Production and Validation: Programs and Datasets (High Complexity)":"prodHigh","SDTM Production and Validation: Programs and Datasets (Medium Complexity)":"prodMedium","SDTM Pinnacle 21 Report Creation and Review":"pinnacle21","SDTM Reviewer's Guide":"reviewersGuide","SDTM Define.xml":"defineXml","SDTM Dataset File xpt Conversion and Review":"xptConversion"}[e]||null}function resetToStart(){return _resetToStart.apply(this,arguments)}function _resetToStart(){return(_resetToStart=_asyncToGenerator(_regenerator().m(function e(){var n,t,o,a,r,s;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:try{uploadedProtocol=null,moduleConfig.setCurrentDocumentId(null),moduleConfig.clearDocumentIdFromSettings(),currentSDTMData=null,document.querySelectorAll(".ms-CheckBox-input").forEach(function(e){e.checked=!1}),document.querySelectorAll(".count-input-container").forEach(function(e){e.style.display="none";var n=e.querySelector(".count-input");n&&(n.value="")}),n=document.getElementById("protocol-upload-area"),t=document.getElementById("protocol-progress"),o=document.getElementById("protocol-result"),a=document.getElementById("protocol-file-input"),n&&(n.style.display="block"),t&&(t.style.display="none"),o&&(o.style.display="none"),a&&(a.value=""),r=document.getElementById("sdtm-mappings-container"),s=document.getElementById("confirmation-status"),r&&(r.style.display="none"),s&&(s.style.display="none"),"function"==typeof resetAIChatInterface&&resetAIChatInterface(),showStep(1),console.log("✅ 应用状态已重置")}catch(e){console.error("❌ 重置应用状态时出错:",e)}case 1:return e.a(2)}},e)}))).apply(this,arguments)}function saveExcelToLocal(){return _saveExcelToLocal.apply(this,arguments)}function _saveExcelToLocal(){return _saveExcelToLocal=_asyncToGenerator(_regenerator().m(function e(){var n;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(n){var t;return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return t=n.workbook,e.n=1,t.save();case 1:return e.n=2,n.sync();case 2:console.log("✅ Excel文件已保存到本地");case 3:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 1:e.n=3;break;case 2:e.p=2,n=e.v,console.error("❌ 保存Excel文件时出错:",n);case 3:return e.a(2)}},e,null,[[0,2]])})),_saveExcelToLocal.apply(this,arguments)}function clearExcelContent(){return _clearExcelContent.apply(this,arguments)}function _clearExcelContent(){return _clearExcelContent=_asyncToGenerator(_regenerator().m(function e(){var n;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,Excel.run(function(){var e=_asyncToGenerator(_regenerator().m(function e(n){return _regenerator().w(function(e){for(;;)switch(e.n){case 0:return n.workbook.worksheets.getActiveWorksheet().getUsedRange().clear(),e.n=1,n.sync();case 1:console.log("✅ Excel内容已清空");case 2:return e.a(2)}},e)}));return function(n){return e.apply(this,arguments)}}());case 1:e.n=3;break;case 2:e.p=2,n=e.v,console.error("❌ 清空Excel内容时出错:",n);case 3:return e.a(2)}},e,null,[[0,2]])})),_clearExcelContent.apply(this,arguments)}var moduleConfig={};function getStep3HTML(){return'\n    <div class="costestimate-step3">\n      <h3 class="ms-font-l">🎯 Project Selection</h3>\n      <p class="ms-font-s">Please select the services you need (multiple selection allowed):</p>\n      <div class="project-options">\n        <div class="project-option">\n          <input type="checkbox" id="project-1" class="ms-CheckBox-input" />\n          <label for="project-1" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">Statistical Analysis Plan and Shells Development (2 Drafts and 1 Final)</span>\n          </label>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-2" class="ms-CheckBox-input" data-requires-count="sdtm-transfer" />\n          <label for="project-2" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">SDTM Datasets Production and Validation</span>\n          </label>\n          <div class="count-input-container" id="sdtm-transfer-container" style="display: none;">\n            <label class="count-label">Data Transfer Times:</label>\n            <input type="number" id="sdtm-transfer-count" class="count-input ms-TextField-field" \n                   min="1" max="999" placeholder="e.g. 5" />\n            <span class="count-suffix">times</span>\n          </div>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-3" class="ms-CheckBox-input" data-requires-count="adam-transfer" />\n          <label for="project-3" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">ADaM Datasets Production and Validation</span>\n          </label>\n          <div class="count-input-container" id="adam-transfer-container" style="display: none;">\n            <label class="count-label">Data Transfer Times:</label>\n            <input type="number" id="adam-transfer-count" class="count-input ms-TextField-field" \n                   min="1" max="999" placeholder="e.g. 3" />\n            <span class="count-suffix">times</span>\n          </div>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-4" class="ms-CheckBox-input" />\n          <label for="project-4" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">Tables, Figures, and Listings Development</span>\n          </label>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-5" class="ms-CheckBox-input" />\n          <label for="project-5" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">Interim Analysis</span>\n          </label>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-6" class="ms-CheckBox-input" />\n          <label for="project-6" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">Final Analysis</span>\n          </label>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-7" class="ms-CheckBox-input" />\n          <label for="project-7" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">DSUR First Time</span>\n          </label>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-8" class="ms-CheckBox-input" data-requires-count="dsur-rerun" />\n          <label for="project-8" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">DSUR Rerun</span>\n          </label>\n          <div class="count-input-container" id="dsur-rerun-container" style="display: none;">\n            <label class="count-label">Rerun Times:</label>\n            <input type="number" id="dsur-rerun-count" class="count-input ms-TextField-field" \n                   min="1" max="999" placeholder="e.g. 4" />\n            <span class="count-suffix">times</span>\n          </div>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-9" class="ms-CheckBox-input" />\n          <label for="project-9" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">DSMB/IDMC First Time</span>\n          </label>\n        </div>\n        <div class="project-option">\n          <input type="checkbox" id="project-10" class="ms-CheckBox-input" data-requires-count="dsmb-rerun" />\n          <label for="project-10" class="ms-CheckBox-label">\n            <span class="ms-CheckBox-field"></span>\n            <span class="ms-CheckBox-text">DSMB Rerun</span>\n          </label>\n          <div class="count-input-container" id="dsmb-rerun-container" style="display: none;">\n            <label class="count-label">Rerun Times:</label>\n            <input type="number" id="dsmb-rerun-count" class="count-input ms-TextField-field" \n                   min="1" max="999" placeholder="e.g. 2" />\n            <span class="count-suffix">times</span>\n          </div>\n        </div>\n      </div>\n\n    </div>\n  '}function getStep4HTML(){return'\n    <div class="costestimate-step4">\n      <h3 class="ms-font-l">🔎 Analyzing Protocol...</h3>\n      <p class="ms-font-s">We are running SDTM analysis based on your uploaded protocol. Please wait.</p>\n      <div class="ms-Spinner">\n        <div class="ms-Spinner-circle ms-Spinner-circle--large"></div>\n      </div>\n    </div>\n  '}function getStep5HTML(){return'\n    <div class="costestimate-step5">\n      <h3 class="ms-font-l">📊 SDTM Analysis Results</h3>\n      \n      <div class="sdtm-summary" id="sdtm-summary">\n        <div class="summary-stats">\n          <div class="stat-item">\n            <span class="stat-label">Procedures Found:</span>\n            <span class="stat-value" id="total-procedures">0</span>\n          </div>\n          <div class="stat-item">\n            <span class="stat-label">SDTM Domains Found:</span>\n            <span class="stat-value" id="total-domains">0</span>\n          </div>\n        </div>\n        <div class="domains-overview">\n          <span class="stat-label">Identified Domains:</span>\n          <div class="domains-list-overview" id="domains-list-overview"></div>\n        </div>\n        \n        <div class="domains-overview">\n          <span class="stat-label">High Complexity SDTM:</span>\n          <div class="domains-list-overview" id="high-complexity-domains"></div>\n        </div>\n        \n        <div class="domains-overview">\n          <span class="stat-label">Medium Complexity SDTM:</span>\n          <div class="domains-list-overview" id="medium-complexity-domains"></div>\n        </div>\n      </div>\n\n      <div class="sdtm-status" id="sdtm-status" style="display: none;">\n        <i class="ms-Icon ms-Icon--Info"></i>\n        <span id="sdtm-status-text">Analyzing procedures...</span>\n      </div>\n\n      <div class="sdtm-mappings-container" id="sdtm-mappings-container" style="display: none;">\n        <div class="mappings-header">\n          <h4 class="ms-font-m">Procedure → SDTM Domain Mappings</h4>\n          <div class="mappings-actions">\n            <button class="ms-Button ms-Button--small" id="edit-mappings-btn">\n              <span class="ms-Button-label">Edit</span>\n            </button>\n            <button class="ms-Button ms-Button--primary" id="confirm-mappings-btn">\n              <span class="ms-Button-label">Confirm & Save</span>\n            </button>\n          </div>\n        </div>\n        \n        <div class="flat-mappings-list" id="flat-mappings-list"></div>\n        \n        <div class="confirmation-status" id="confirmation-status" style="display: none;">\n          <i class="ms-Icon ms-Icon--CheckMark"></i>\n          <span>SDTM Analysis Confirmed and Saved</span>\n        </div>\n      </div>\n    </div>\n  '}function getStep6HTML(){return'\n    <div class="costestimate-step6">\n      <div class="completion-confirmation-section">\n        <div class="completion-icon">\n          <span class="ms-Icon ms-Icon--CheckMark" style="font-size: 48px; color: #28a745;"></span>\n        </div>\n        \n        <h3 class="completion-title">Analysis Complete!</h3>\n        \n        <div class="completion-message">\n          <p>🎉 All the analysis are done successfully!</p>\n          <p>Your cost estimation and SDTM mapping have been completed and saved to Excel.</p>\n          <p>Click "Done" to confirm completion and start a new project.</p>\n        </div>\n        \n\n      </div>\n    </div>\n  '}function insertCostEstimateHTML(){var e=document.getElementById("costestimate-step3-container");e&&(e.innerHTML=getStep3HTML());var n=document.getElementById("costestimate-step4-container");n&&(n.innerHTML=getStep4HTML());var t=document.getElementById("costestimate-step5-container");t&&(t.innerHTML=getStep5HTML());var o=document.getElementById("costestimate-step6-container");o&&(o.innerHTML=getStep6HTML())}function initCostEstimateModule(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};console.log("🚀 初始化 costestimate 模块..."),moduleConfig={API_BASE_URL:e.API_BASE_URL||"https://localhost:4000",showStep:e.showStep||function(){return console.warn("showStep not provided")},showStatusMessage:e.showStatusMessage||function(e,n){return console.warn("showStatusMessage not provided:",e)},cacheExcelState:e.cacheExcelState||function(){return console.warn("cacheExcelState not provided")},restoreExcelState:e.restoreExcelState||function(){return console.warn("restoreExcelState not provided")},getCurrentDocumentId:e.getCurrentDocumentId||function(){return console.warn("getCurrentDocumentId not provided")},setCurrentDocumentId:e.setCurrentDocumentId||function(){return console.warn("setCurrentDocumentId not provided")},clearDocumentIdFromSettings:e.clearDocumentIdFromSettings||function(){return console.warn("clearDocumentIdFromSettings not provided")}},insertCostEstimateHTML(),initProjectSelectionLogic(),bindSDTMButtonEvents(),console.log("✅ costestimate 模块初始化完成")}function resetCostEstimateModule(){console.log("🔄 重置 costestimate 模块..."),"undefined"!=typeof currentSDTMData&&(currentSDTMData=null),moduleConfig&&"function"==typeof moduleConfig.setUploadedProtocol&&moduleConfig.setUploadedProtocol(null),resetToStart(),console.log("✅ costestimate 模块重置完成")}function loadAndDisplaySDTMResults(){return _loadAndDisplaySDTMResults.apply(this,arguments)}function _loadAndDisplaySDTMResults(){return(_loadAndDisplaySDTMResults=_asyncToGenerator(_regenerator().m(function e(){var n,t,o,a,r,s,i,c,l,u,d,m,p,f,g,v,y,h,b,D;return _regenerator().w(function(e){for(;;)switch(e.p=e.n){case 0:if(e.p=0,i=moduleConfig.getCurrentDocumentId()){e.n=1;break}return console.warn("没有当前文档ID，无法加载SDTM结果"),e.a(2);case 1:return console.log("🔄 自动加载SDTM分析结果并恢复Excel状态..."),e.n=2,fetch("".concat(moduleConfig.API_BASE_URL,"/api/documents/").concat(i,"/content"));case 2:if((c=e.v).ok){e.n=3;break}throw new Error("Failed to load document: ".concat(c.statusText));case 3:return e.n=4,c.json();case 4:return l=e.v,console.log("🔍 [DEBUG] API返回的完整数据结构:",JSON.stringify(l,null,2)),u=null===(n=l.document)||void 0===n||null===(n=n.CostEstimateDetails)||void 0===n?void 0:n.sdtmAnalysisStatus,console.log("🔍 [DEBUG] 当前项目状态:",u),console.log("🔧 重建Excel基础表格结构..."),e.n=5,createStandardCostAnalysisHeaders();case 5:if(console.log("🔧 填充已选择的项目内容..."),!((d=null===(t=l.document)||void 0===t||null===(t=t.CostEstimateDetails)||void 0===t||null===(t=t.projectSelection)||void 0===t?void 0:t.selectionDetails)&&Object.keys(d).length>0)){e.n=7;break}return console.log("🔍 [DEBUG] 传递项目选择数据:",d),e.n=6,populateExcelWithSelectedProjects(d);case 6:e.n=8;break;case 7:return console.warn("⚠️ 没有找到项目选择数据，跳过Excel表格填充"),moduleConfig.showStatusMessage("No project selection data found, cannot restore Excel table","warning"),e.a(2);case 8:if("user_confirmed_sdtm_done"!==u){e.n=11;break}if(f=null===(m=l.document)||void 0===m||null===(m=m.CostEstimateDetails)||void 0===m?void 0:m.sdtmTableInput,!(g=null==f?void 0:f["SDTM Datasets Production and Validation"])||!g.units){e.n=9;break}return console.log("🔧 恢复已确认的SDTM Unit和Cost数据..."),e.n=9,applySDTMUnitsAndCostsToExcel(g);case 9:if(!(v=null===(p=l.document)||void 0===p||null===(p=p.CostEstimateDetails)||void 0===p?void 0:p.userConfirmedSdtm)||!v.success){e.n=10;break}return console.log("🔧 恢复已确认的SDTM Notes..."),e.n=10,applySDTMNotesToExcel(v);case 10:console.log("✅ Excel状态已恢复到已确认状态（含Unit/Cost数据）"),e.n=12;break;case 11:"sdtm_ai_analysis_done"===u?console.log("✅ Excel状态已恢复到AI分析完成状态（空Unit/Cost，待用户确认）"):console.log("✅ Excel状态已恢复到项目选择完成状态");case 12:if(y=null,h=null===(o=l.document)||void 0===o||null===(o=o.CostEstimateDetails)||void 0===o?void 0:o.userConfirmedSdtm,b=null===(a=l.document)||void 0===a||null===(a=a.CostEstimateDetails)||void 0===a?void 0:a.sdtmAnalysis,h&&h.success&&(null===(r=h.procedures)||void 0===r?void 0:r.length)>0?(console.log("🔍 [DEBUG] 使用用户确认的SDTM数据"),y=_objectSpread(_objectSpread({},h),{},{mappings:h.mappings?convertMapToMappingsList(h.mappings,h.procedures):[]})):b&&(b.success||(null===(s=b.procedures)||void 0===s?void 0:s.length)>0)&&(console.log("🔍 [DEBUG] 使用原始AI分析的SDTM数据"),y=b),console.log("🔍 [DEBUG] 最终选择的SDTM数据:",y),!y){e.n=14;break}return console.log("✅ SDTM分析结果加载成功"),e.n=13,displaySDTMAnalysis(y);case 13:e.n=15;break;case 14:console.warn("⚠️ 没有找到有效的SDTM分析结果"),moduleConfig.showStatusMessage("No SDTM analysis results found","warning");case 15:e.n=17;break;case 16:e.p=16,D=e.v,console.error("❌ 加载SDTM结果失败:",D),moduleConfig.showStatusMessage("Failed to load SDTM results: "+D.message,"error");case 17:return e.a(2)}},e,null,[[0,16]])}))).apply(this,arguments)}"undefined"!=typeof window&&(window.CostEstimateModule={init:initCostEstimateModule,reset:resetCostEstimateModule,initProjectSelectionLogic:initProjectSelectionLogic,saveProjectSelectionDetails:saveProjectSelectionDetails,createStandardCostAnalysisHeaders:createStandardCostAnalysisHeaders,populateExcelWithSelectedProjects:populateExcelWithSelectedProjects,displaySDTMAnalysis:displaySDTMAnalysis,confirmSDTMAnalysis:confirmSDTMAnalysis,applySDTMUnitsAndCostsToExcel:applySDTMUnitsAndCostsToExcel,applySDTMNotesToExcel:applySDTMNotesToExcel,loadAndDisplaySDTMResults:loadAndDisplaySDTMResults,saveExcelChangesToDatabase:saveExcelChangesToDatabase,resetToStart:resetToStart,saveExcelToLocal:saveExcelToLocal,clearExcelContent:clearExcelContent,handleEditMappings:handleEditMappings,bindSDTMButtonEvents:bindSDTMButtonEvents},window.handleEditMappings=handleEditMappings,window.confirmSDTMAnalysis=confirmSDTMAnalysis);